name: í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬
on:
  push:
    branches: [main]
    paths:
      - "packages/frontend/**"
      - "packages/shared/**"

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: PNPM ì„¤ì •
        uses: pnpm/action-setup@v2
        with:
          version: 9.4.0

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v3
        with:
          node-version: "22.9.0"
          cache: "pnpm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        id: install
        run: pnpm install
        continue-on-error: true

      - name: Shared íŒ¨í‚¤ì§€ ë¹Œë“œ
        id: build-shared
        if: steps.install.outcome == 'success'
        working-directory: packages/shared
        run: pnpm build
        continue-on-error: true

      - name: Frontend íŒ¨í‚¤ì§€ ë¹Œë“œ
        id: build-frontend
        if: steps.build-shared.outcome == 'success'
        working-directory: packages/frontend
        run: pnpm build
        continue-on-error: true

      - name: NCP ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        if: steps.build-frontend.outcome == 'success'
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.CONTAINER_REGISTRY_URL }}
          username: ${{ secrets.NCP_ACCESS_KEY }}
          password: ${{ secrets.NCP_SECERET_KEY }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        id: docker-build
        if: steps.build-frontend.outcome == 'success'
        uses: docker/build-push-action@v3
        with:
          context: .
          file: ./packages/frontend/Dockerfile
          push: true
          tags: ${{ secrets.CONTAINER_REGISTRY_URL }}/frontend:latest

      - name: ë°°í¬ ê²°ê³¼ ì²˜ë¦¬
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const getKSTDate = () => {
              const date = new Date();
              date.setHours(date.getHours() + 9); 
              return date.toISOString();
            };

            const installOutcome = '${{ steps.install.outcome }}';
            const sharedOutcome = '${{ steps.build-shared.outcome }}';
            const frontendOutcome = '${{ steps.build-frontend.outcome }}';
            const dockerOutcome = '${{ steps.docker-build.outcome }}';

            const getFailedStep = () => {
              if (installOutcome === 'failure') return 'ì˜ì¡´ì„± ì„¤ì¹˜';
              if (sharedOutcome === 'failure') return 'Shared íŒ¨í‚¤ì§€ ë¹Œë“œ';
              if (frontendOutcome === 'failure') return 'Frontend íŒ¨í‚¤ì§€ ë¹Œë“œ';
              if (dockerOutcome === 'failure') return 'Docker ë¹Œë“œ ë° í‘¸ì‹œ';
              return 'ì•Œ ìˆ˜ ì—†ìŒ';
            };

            const finalOutcome = 
              installOutcome === 'success' && 
              sharedOutcome === 'success' && 
              frontendOutcome === 'success' && 
              dockerOutcome === 'success' 
                ? 'success' : 'failure';

            try {
              await github.rest.checks.create({
                ...context.repo,
                name: 'í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ìƒíƒœ',
                head_sha: context.sha,
                status: 'completed',
                conclusion: finalOutcome,
                output: {
                  title: finalOutcome === 'success' 
                    ? 'ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì„±ê³µ' 
                    : 'âŒ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì‹¤íŒ¨',
                  summary: finalOutcome === 'success'
                    ? [
                        '## âœ… ë°°í¬ ìƒíƒœ: ì„±ê³µ',
                        '',
                        '### ë°°í¬ ì •ë³´:',
                        '- ğŸ“… **ë°°í¬ ì‹œê°„**: ' + getKSTDate(),
                        '- ğŸŒ **í™˜ê²½**: Production',
                        '- ğŸ“¦ **ë¹Œë“œëœ íŒ¨í‚¤ì§€**: shared, frontend',
                        '- ğŸ¯ **ëŒ€ìƒ**: NCP Container Registry',
                        '',
                        '### ë¹Œë“œ ë‹¨ê³„ ê²°ê³¼:',
                        '- âœ… ì˜ì¡´ì„± ì„¤ì¹˜: ì„±ê³µ',
                        '- âœ… Shared íŒ¨í‚¤ì§€ ë¹Œë“œ: ì„±ê³µ',
                        '- âœ… Frontend íŒ¨í‚¤ì§€ ë¹Œë“œ: ì„±ê³µ',
                        '- âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ: ì„±ê³µ',
                        '',
                        'ğŸ‰ í”„ë¡œë•ì…˜ í™˜ê²½ì— ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!'
                      ].join('\n')
                    : [
                        '## âŒ ë°°í¬ ìƒíƒœ: ì‹¤íŒ¨',
                        '',
                        '### ì˜¤ë¥˜ ì •ë³´:',
                        '- ğŸ“… **ì‹¤íŒ¨ ì‹œê°„**: ' + getKSTDate(),
                        '- ğŸš¨ **ì‹¤íŒ¨ ë‹¨ê³„**: ' + getFailedStep(),
                        '',
                        '### ë¹Œë“œ ë‹¨ê³„ ê²°ê³¼:',
                        `- ${installOutcome === 'success' ? 'âœ…' : 'âŒ'} ì˜ì¡´ì„± ì„¤ì¹˜: ${installOutcome}`,
                        `- ${sharedOutcome === 'success' ? 'âœ…' : 'âŒ'} Shared íŒ¨í‚¤ì§€ ë¹Œë“œ: ${sharedOutcome}`,
                        `- ${frontendOutcome === 'success' ? 'âœ…' : 'âŒ'} Frontend íŒ¨í‚¤ì§€ ë¹Œë“œ: ${frontendOutcome}`,
                        `- ${dockerOutcome === 'success' ? 'âœ…' : 'âŒ'} Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ: ${dockerOutcome}`,
                        '',
                        '### ë¬¸ì œ í•´ê²° ë°©ë²•:',
                        '1. ì‹¤íŒ¨í•œ ë‹¨ê³„ì˜ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”',
                        '2. ì˜ì¡´ì„± ë° ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”',
                        '3. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”',
                        '',
                      ].join('\n')
                }
              });
            } catch (error) {
              console.error('Error creating check:', error);
              core.setFailed(`Check creation failed: ${error.message}`);
            }
