name: Frontend Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'packages/frontend/**'
      - 'packages/shared/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      deployments: write

    steps:
      - uses: actions/checkout@v3
      
      - uses: pnpm/action-setup@v2
        with:
          version: 9.4.0
      
      - uses: actions/setup-node@v3
        with:
          node-version: '22.9.0'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install

      # shared íŒ¨í‚¤ì§€ ë¨¼ì € ë¹Œë“œ
      - name: Build shared package
        id: build-shared
        working-directory: packages/shared
        run: pnpm build
        continue-on-error: true

      # ğŸš¨ shared ë¹Œë“œ ì‹¤íŒ¨ ì‹œ ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì¤‘ë‹¨
      - name: Check shared build
        if: steps.build-shared.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          script: |
            core.setFailed('Shared package build failed');
      
      # frontend ë¹Œë“œ ë° ë°°í¬
      - name: Build and Deploy Frontend
        id: deploy
        if: steps.build-shared.outcome == 'success'
        working-directory: packages/frontend
        env:
          NCP_ACCESS_KEY: ${{ secrets.NCP_ACCESS_KEY }}
          NCP_SECRET_KEY: ${{ secrets.NCP_SECRET_KEY }}
          NCP_BUCKET_NAME: ${{ secrets.NCP_BUCKET_NAME }}
        run: |
          echo "ğŸ—ï¸ Building frontend..."
          pnpm build
          
          echo "ğŸ“¦ Installing NCP CLI..."
          pip install ncli
          
          echo "ğŸš€ Deploying to NCP Object Storage..."
          ncli objectstorage cp -r ./dist/* s3://$NCP_BUCKET_NAME/
        continue-on-error: true

      # ë°°í¬ ê²°ê³¼ ì²˜ë¦¬
      - name: Process Deploy Result
        uses: actions/github-script@v6
        with:
          script: |
            const sharedOutcome = '${{ steps.build-shared.outcome }}';
            const deployOutcome = '${{ steps.deploy.outcome }}';
            const finalOutcome = sharedOutcome === 'success' && deployOutcome === 'success' ? 'success' : 'failure';
            
            // GitHub Checksë¡œ ë°°í¬ ìƒíƒœ ë³´ê³ 
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.name,
              name: 'Frontend Deploy',
              head_sha: context.sha,
              status: 'completed',
              conclusion: finalOutcome === 'success' ? 'success' : 'failure',
              output: {
                title: finalOutcome === 'success' 
                  ? 'ğŸš€ Frontend Deploy Successful' 
                  : 'âŒ Frontend Deploy Failed',
                summary: finalOutcome === 'success'
                  ? [
                      '## âœ… Deploy Status: Success',
                      '',
                      '### Build & Deploy Information:',
                      '- **Time**: ' + new Date().toISOString(),
                      '- **Environment**: Production',
                      '- **Packages Built**: shared, frontend',
                      '- **Target**: NCP Object Storage',
                      '',
                      'ğŸ‰ Successfully deployed to production!'
                    ].join('\n')
                  : [
                      '## âŒ Deploy Status: Failed',
                      '',
                      '### Error ì •ë³´:',
                      '- **Time**: ' + new Date().toISOString(),
                      '- **Failed Step**: ' + (sharedOutcome === 'failure' ? 'Shared Package Build' : 'Frontend Deploy'),
                      '',
                      '### Error ë¶€ê°€ì •ë³´:',
                      sharedOutcome === 'failure' 
                        ? '- Shared package build failed. Check the shared package build logs.'
                        : '- Frontend deployment failed. Check the deployment logs.',
                      '',
                    ].join('\n')
              }
            });
            
            // ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤íŒ¨ ìƒíƒœë¡œ ë§Œë“¦
            if (finalOutcome === 'failure') {
              core.setFailed('Deployment process failed');
            }