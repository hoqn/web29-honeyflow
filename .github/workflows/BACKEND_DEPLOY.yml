name: ë°±ì—”ë“œ ë°°í¬
on:
  push:
    branches: [main]
    paths:
      - "packages/backend/**"
      - "packages/shared/**"
jobs:
  push_to_registry:
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v2

      - name: NCP ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.CONTAINER_REGISTRY_URL }}
          username: ${{ secrets.NCP_ACCESS_KEY }}
          password: ${{ secrets.NCP_SECERET_KEY }}

      - name: ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        id: docker-build
        uses: docker/build-push-action@v3
        with:
          context: .
          file: ./packages/backend/Dockerfile
          push: true
          tags: ${{secrets.CONTAINER_REGISTRY_URL}}/nodejs-server:latest

      - name: ë°°í¬ ê²°ê³¼ ì²˜ë¦¬
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const buildOutcome = '${{ steps.docker-build.outcome }}';
            const repoName = context.repo.repo; 

            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: repoName, 
              name: 'ë°±ì—”ë“œ ë°°í¬ ìƒíƒœ',
              head_sha: context.sha,
              status: 'completed',
              conclusion: buildOutcome === 'success' ? 'success' : 'failure',
              output: {
                title: buildOutcome === 'success' 
                  ? 'ğŸš€ ë°±ì—”ë“œ ë°°í¬ ì„±ê³µ' 
                  : 'âŒ ë°±ì—”ë“œ ë°°í¬ ì‹¤íŒ¨',
                summary: buildOutcome === 'success'
                  ? [
                      '## âœ… ë°°í¬ ìƒíƒœ: ì„±ê³µ',
                      '',
                      '### ë°°í¬ ì •ë³´:',
                      '- ğŸ“… **ë°°í¬ ì‹œê°„**: ' + new Date().toISOString(),
                      '- ğŸŒ **í™˜ê²½**: Production',
                      '- ğŸ“¦ **ì´ë¯¸ì§€**: nodejs-server:latest',
                      '- ğŸ¯ **ëŒ€ìƒ**: NCP Container Registry',
                      '',
                      'ğŸ‰ í”„ë¡œë•ì…˜ í™˜ê²½ì— ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!'
                    ].join('\n')
                  : [
                      '## âŒ ë°°í¬ ìƒíƒœ: ì‹¤íŒ¨',
                      '',
                      '### ì˜¤ë¥˜ ì •ë³´:',
                      '- ğŸ“… **ì‹¤íŒ¨ ì‹œê°„**: ' + new Date().toISOString(),
                      '- ğŸš¨ **ì‹¤íŒ¨ ë‹¨ê³„**: Docker ë¹Œë“œ ë° í‘¸ì‹œ',
                      '',
                      '### ë¬¸ì œ í•´ê²° ë°©ë²•:',
                      '1. Dockerfile ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”',
                      '2. ë¹Œë“œ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”',
                      '3. NCP ì¸ì¦ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”',
                      '',
                    ].join('\n')
              }
            });
